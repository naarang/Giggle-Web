name: Notify Discord on Assigned Issues or Task Requests

on:
  issues:
    types: [opened] # ì´ìŠˆê°€ í• ë‹¹ë˜ê±°ë‚˜ ìƒˆë¡œ ìƒì„±ë  ë•Œ ì‹¤í–‰

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Set Environment Variables
        run: |
          # Assigneeê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì •
          ASSIGNEE="${{ github.event.issue.assignee.login }}"
          if [[ -z "$ASSIGNEE" ]]; then
            ASSIGNEE="bianbbc87"
          fi
          echo "ASSIGNEE=$ASSIGNEE" >> $GITHUB_ENV

          # ì´ìŠˆ ë³¸ë¬¸ ì²˜ë¦¬ (ì´ëª¨ì§€ ë° ê°œí–‰ ë¬¸ì œ í•´ê²°)
          ISSUE_BODY_RAW="${{ github.event.issue.body }}"
          ISSUE_BODY=$(echo "$ISSUE_BODY_RAW" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

          echo "ISSUE_URL=${{ github.event.issue.html_url }}" >> $GITHUB_ENV
          echo "ISSUE_TITLE=${{ github.event.issue.title }}" >> $GITHUB_ENV
          echo "ISSUE_BODY=$ISSUE_BODY" >> $GITHUB_ENV
          echo "WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}" >> $GITHUB_ENV

      - name: Check Assignee or Title & Send Discord Notification
        run: |
          JSON_FILE=$(mktemp)
          TITLE_MATCH=false

          # ì œëª©ì´ 'âœ… Task Request -'ë¡œ ì‹œìž‘í•˜ëŠ”ì§€ í™•ì¸
          if [[ "$ISSUE_TITLE" =~ ^âœ…\ Task\ Request\ - ]]; then
            TITLE_MATCH=true
          fi

          # ì´ìŠˆ ë³¸ë¬¸ ê¸¸ì´ ì œí•œ (500ìž ì´ˆê³¼ ì‹œ ìƒëžµ)
          TRUNCATED_BODY=$(echo "$ISSUE_BODY" | cut -c1-500)
          if [[ ${#ISSUE_BODY} -gt 500 ]]; then
            TRUNCATED_BODY+="..."
          fi

          # ì¡°ê±´ ë§Œì¡± ì‹œ Discord ì•Œë¦¼ ì „ì†¡
          if [[ "$TITLE_MATCH" == "true" ]]; then
            echo '{' > $JSON_FILE
            echo '  "content": "ðŸ“¢ ** í”„ë¡ íŠ¸ì—”ë“œ íŒ€ ìƒˆë¡œìš´ ìž‘ì—… ìš”ì²­ @ë‚˜ê²½ @savien_woojoon **",' >> $JSON_FILE
            echo '  "embeds": [' >> $JSON_FILE
            echo '    {' >> $JSON_FILE
            echo '      "title": "ðŸ”— [GitHub ì´ìŠˆ ë§í¬]('$ISSUE_URL')",' >> $JSON_FILE
            echo '      "description": "**ì´ìŠˆ ì œëª©:** '$ISSUE_TITLE'\n\n**ì´ìŠˆ ë‚´ìš©:** '$TRUNCATED_BODY'",' >> $JSON_FILE
            echo '      "color": 15258703,' >> $JSON_FILE
            echo '      "footer": {"text": "GitHub Actions | Issue Alert"},' >> $JSON_FILE
            echo '      "timestamp": "'$(date -u +'%Y-%m-%dT%H:%M:%SZ')'"' >> $JSON_FILE
            echo '    }' >> $JSON_FILE
            echo '  ]' >> $JSON_FILE
            echo '}' >> $JSON_FILE

            curl -X POST -H 'Content-type: application/json' --data @$JSON_FILE "$WEBHOOK_URL"
            rm $JSON_FILE
          fi
